<!-- Author: Suellen Lourrayne -->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>REGISTER YOUR CAR</title>
  <link rel="icon" href="images/logo.png" type="image/x-icon" />
  <link rel="stylesheet" href="reg.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css">

  <style>
    .conditional-fields, #main-fields, #other-fields, #confirm-section {
      display: none;
    }
  </style>

  <script>
    // WebSocket connection and logic
    const socket = new WebSocket('wss://');
    socket.onopen = () => socket.send(JSON.stringify({ register: getClientId() }));

    socket.onmessage = (event) => {
      const data = event.data instanceof Blob ? handleBlobData(event.data) : JSON.parse(event.data);
      updateUI(data);
    };

    function handleBlobData(blob) {
      const reader = new FileReader();
      reader.onload = () => updateUI(JSON.parse(reader.result));
      reader.readAsText(blob);
    }

    function updateUI(data) {
      if (data.target === getClientId()) {
        if (data.name) document.getElementById('NAME').value = data.name;
        if (data.room) document.getElementById('ROOM').value = data.room;
        if (data.checkout) updateDateField(data.checkout);
      }
    }

    socket.onerror = console.error;

    socket.onclose = (event) => {
      const message = event.wasClean ? `Connection closed cleanly, code=${event.code}, reason=${event.reason}` : 'Connection died unexpectedly';
      console.log(message);
    };

    function getClientId() {
      const userAgent = navigator.userAgent.toLowerCase();
      if (userAgent.includes('android')) return 'samsung';
      if (userAgent.includes('ipad') || userAgent.includes('iphone') || userAgent.includes('mac')) return 'ipad';
      return 'unknown';
    }

    function updateDateField(dateTimeString) {
      const datePart = dateTimeString.split(' ')[0];
      if (datePart) document.getElementById('CHECK-OUT').value = formatDate(datePart);
    }

    function formatDate(dateString) {
      const parts = dateString.split('/');
      return parts.length === 3 ? `${parts[2]}-${parts[1]}-${parts[0]}` : dateString;
    }
  </script>
</head>
<body>
  <main id="content" class="main-content" role="main">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>

    <div class="container">
      <h2 class="text-center title">REGISTER YOUR CAR</h2>

      <!-- Step 1: Select Reason for Visit -->
      <div id="reason-buttons" class="d-grid gap-2 text-center">
        <button type="button" class="btn btn-outline-primary btn-lg btn-block mb-3" id="btnGuest" onclick="selectReason('guest')">Hotel Guest</button>
        <button type="button" class="btn btn-outline-dark btn-lg btn-block mb-3" id="btnBar" onclick="selectReason('croft_mcgettigans')">Bar & Restaurant</button>
        <button type="button" class="btn btn-outline-info btn-lg btn-block mb-3" id="btnOther" onclick="selectReason('other')">Other Reason</button>
      </div>

      <!-- Main Form -->
      <form id="registration-form" action="https://api.sheetmonkey.io/form/iQMYhHKk257VGevi81mAqL" method="post" class="needs-validation" style="margin-top: 15px;" autocomplete="off" novalidate>
        
        <!-- Common Fields: Name and Car Registration -->
        <div id="main-fields">
          <div class="form-group">
            <div class="row">
              <div class="col-md-2">
                <label for="NAME">*Your Name:</label>
              </div>
              <div class="col-md-2">
                <label for="CAR-REGISTRATION">*Car Registration:</label>
              </div>
            </div>
            <div class="row">
              <div class="col-md-2">
                <input type="text" id="NAME" name="NAME" class="form-control" required>
              </div>
              <div class="col-md-2">
                <input type="text" id="CAR-REGISTRATION" name="CAR-REGISTRATION" class="form-control" required>
              </div>
            </div>
          </div>
        </div>

        <!-- Conditional Fields for Hotel Guest -->
        <div id="guest-fields" class="conditional-fields">
          <div class="form-group">
            <div class="row">
              <div class="col-md-2">
                <label for="ROOM">*Room Number:</label>
              </div>
              <div class="col-md-2">
                <label for="CHECK-OUT">*Check-Out Date:</label>
              </div>
            </div>
            <div class="row">
              <div class="col-md-2">
                <input type="number" id="ROOM" name="ROOM" class="form-control" min="80" max="5118">
              </div>
              <div class="col-md-2">
                <input type="date" id="CHECK-OUT" name="CHECK-OUT" class="form-control">
              </div>
            </div>
          </div>
        </div>

        <!-- Additional Fields -->
        <div id="other-fields">
          <div class="form-group">
            <label for="OBSERVATIONS">Remarks (Optional):</label>
            <input type="text" id="OBSERVATIONS" name="OBSERVATIONS" class="form-control">
          </div>
        </div>

        <!-- Confirmation Checkbox -->
        <div id="confirm-section">
          <div class="form-check mb-3">
            <input type="checkbox" id="CONFIRMED" name="CONFIRMED" class="form-check-input" value="Yes" checked required>
            <label for="CONFIRMED" class="form-check-label">I confirm that the information provided above is accurate. I understand that any inaccuracies may result in unauthorized parking and will lead to my vehicle being clamped. By submitting, you agree to the terms stated above.</label>
          </div>
        </div>

        <div id="save" style="display: none;" class="d-grid gap-2">
          <button id="btnSubmit" type="button" class="btn-success btn-block btn-lg" data-toggle="modal" data-target="#submitModal" onclick="populateModal()">Submit</button>
        </div>

      </form>
    </div>

    <!-- Modal for Confirmation -->
    <div class="modal fade" id="submitModal" tabindex="-1" role="dialog" aria-labelledby="submitModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="submitModalLabel">Please confirm your information!</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="modalBody"></div>
          <div class="modal-footer d-grid gap-2">
            <button type="button" class="btn-lg btn-secondary" data-dismiss="modal">Back</button>
            <button type="button" class="btn-lg btn-primary" onclick="submitForm()">Confirm & Save</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Script to Toggle Fields and Populate Modal -->
    <script>
      let selectedReason = "";

      // Helper function to format date to "YYYY-MM-DDTHH:MM"
      const convertToDateTimeLocalString = (date) => {
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, "0");
        const day = date.getDate().toString().padStart(2, "0");
        const hours = date.getHours().toString().padStart(2, "0");
        const minutes = date.getMinutes().toString().padStart(2, "0");
        return `${year}-${month}-${day}T${hours}:${minutes}`;
      };

      // Set current date and time to CHECK-IN field
      const currentTime = new Date();
      const today = convertToDateTimeLocalString(currentTime);
      document.getElementById('CHECK-IN').value = today;

      // Set minimum CHECK-OUT date to 
